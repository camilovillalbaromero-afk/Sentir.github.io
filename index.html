<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>EmotionSpace - App M√≥vil</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: white;
            --text-color: #2c3e50;
            --card-bg-color: white;
            --card-border-color: #f0f0f0;
            --subtle-bg-color: #f8f9ff;
            --tab-nav-bg: white;
            --tab-nav-border: #e0e0e0;
            --primary-accent: #667eea;
            --secondary-text-color: #666;
            --positive-color: #4CAF50;
            --negative-color: #F44336;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg-color: #2a2a2a;
            --card-border-color: #404040;
            --subtle-bg-color: #333;
            --tab-nav-bg: #2a2a2a;
            --tab-nav-border: #404040;
            --secondary-text-color: #aaa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            max-width: 400px;
            width: 100%;
            height: 90vh;
            margin: 0 auto;
            background: var(--bg-color);
            color: var(--text-color);
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 30px;
            box-shadow: 0 0 0 10px rgba(0,0,0,0.1),
                          0 0 0 12px #333,
                          0 20px 50px rgba(0,0,0,0.4);
            -webkit-overflow-scrolling: touch;
        }

        .status-bar {
            height: 44px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }

        .tab-navigation {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--tab-nav-bg);
            border-top: 1px solid var(--tab-nav-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom);
            width: 100%;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: var(--secondary-text-color);
            flex-grow: 1;
            text-align: center;
        }

        .tab-item.active {
            background: linear-gradient(135deg, #667eea20, #764ba240);
            color: var(--primary-accent);
        }

        .tab-item .icon { font-size: 18px; margin-bottom: 4px; }
        .tab-item .label { font-size: 10px; font-weight: 600; }

        .content-section {
            display: none;
            padding: 20px;
            min-height: calc(100% - 44px);
            box-sizing: border-box;
        }
        .content-section:last-of-type {
            padding-bottom: 100px;
        }


        .content-section.active { display: block; }
        .section-header { text-align: center; margin-bottom: 24px; }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle { font-size: 16px; color: var(--secondary-text-color); opacity: 0.8; }
        
        .card {
            background: var(--card-bg-color);
            border-radius: 20px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--card-border-color);
        }

        .video-container {
            background: var(--card-bg-color);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .video-embed { position: relative; width: 100%; height: 0; padding-bottom: 56.25%; overflow: hidden; border-radius: 12px; background: #000; }
        .video-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        .emotions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .emotion-card {
            background: var(--card-bg-color);
            border: 2px solid var(--card-border-color);
            border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; position: relative; overflow: hidden; min-height: 160px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .emotion-card:active { transform: scale(0.95); }
        .emotion-card.active { transform: scale(1.05); box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3); border-color: #667eea; }
        .emotion-icon { width: 50px; height: 50px; margin: 0 auto 12px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; animation: pulse 2s infinite;
        }
        .emotion-name { font-size: 16px; font-weight: 700; color: var(--text-color); margin-bottom: 8px; text-align: center; }
        .level-bar { height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .level-fill { height: 100%; border-radius: 3px; transition: width 1s ease-out;
            background: linear-gradient(90deg, #667eea, #764ba2); }
        .level-percentage { font-size: 12px; font-weight: 600; color: var(--secondary-text-color);
            text-align: center; margin-top: 4px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; }
        .stat-card, .diary-stat-card { background: var(--card-bg-color);
            border: 2px solid var(--card-border-color); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number, .diary-stat-number { font-size: 32px; font-weight: 800; color: var(--primary-accent); margin-bottom: 8px;
            line-height: 1; }
        .stat-label, .diary-stat-label { color: var(--secondary-text-color); font-weight: 600; font-size: 12px; }

        .fab {
            position: fixed;
            bottom: 100px;
            right: calc(50% - 200px + 20px);
            width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; z-index: 999;
        }
        @media (max-width: 420px) {
            .fab {
                right: 20px;
            }
        }
        .fab:active { transform: scale(0.9); }

        .btn-mobile { padding: 16px 24px; border: none; border-radius: 16px; font-weight: 600;
            cursor: pointer; font-size: 16px; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }
        .btn-success { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;
            box-shadow: 0 4-15px rgba(79, 172, 254, 0.3); }
        .btn-mobile:active { transform: scale(0.98); }
        .control-buttons { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        .control-buttons.row { flex-direction: row; justify-content: center; gap: 16px; }

        .mood-input { 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px; 
            margin-top: 20px;
        }
        .mood-emoji { 
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            font-size: 32px;
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            border-radius: 16px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: var(--subtle-bg-color);
            border: 2px solid var(--card-border-color);
            padding: 12px;
        }
        .mood-emoji .emoji-label {
            font-size: 12px;
            margin-top: 8px;
            color: var(--secondary-text-color);
            font-weight: 600;
            text-align: center;
        }

        .mood-emoji:active { transform: scale(0.9); }
        .mood-emoji.selected { background: linear-gradient(135deg, #667eea, #764ba2); transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }

        .breathing-circle { width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2); margin: 20px auto; animation: breathe 4s infinite;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 600;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .game-area { width: 100%; height: 250px; background: var(--subtle-bg-color); border-radius: 12px;
            margin-top: 16px; position: relative; overflow: hidden;
        }
        .bubble { position: absolute; bottom: -20px; background: rgba(102, 126, 234, 0.5);
            border-radius: 50%; animation: float 5s infinite; cursor: pointer; }
        @keyframes float { 0% { transform: translateY(0); } 100% { transform: translateY(-300px); } }

        .memory-game-grid { display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; height: 300px;
            padding: 12px; box-sizing: border-box;
        }
        .memory-card { background: var(--subtle-bg-color); border-radius: 8px; display: flex;
            align-items: center; justify-content: center; font-size: 28px; cursor: pointer;
            transition: transform 0.6s; transform-style: preserve-3d; position: relative;
        }
        .memory-card.flip { transform: rotateY(180deg); }
        .memory-card .front-face, .memory-card .back-face { position: absolute; backface-visibility: hidden; }
        .memory-card .front-face { transform: rotateY(180deg); }
        .memory-card.match .front-face { color: var(--positive-color); }
        .game-score { display: flex; justify-content: space-around; font-size: 14px;
            font-weight: 600; margin-bottom: 16px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: flex-end; z-index: 2000;
        }
        .modal.show { display: flex; }
        .modal-content { background: var(--card-bg-color); border-radius: 20px 20px 0 0; padding: 24px;
            width: 100%; max-height: 80vh; overflow-y: auto; transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content { transform: translateY(0); }
        .modal-header { display: flex; align-items: center; margin-bottom: 20px; gap: 16px; }
        .modal-emoji { width: 60px; height: 60px; font-size: 30px; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; background: linear-gradient(135deg, #f8f9ff, #e8f4f8);
        }
        .close-btn { position: absolute; top: 16px; right: 20px; background: none;
            border: none; font-size: 24px;
            cursor: pointer; color: #999; width: 32px; height: 32px; display: flex;
            align-items: center; justify-content: center; border-radius: 50%;
        }
        .advice-section { margin-bottom: 20px; }
        .advice-section h4 { color: var(--primary-accent); margin-bottom: 12px; font-size: 18px; }
        .advice-list { list-style: none; }
        .advice-list li { background: var(--subtle-bg-color); padding: 12px 16px; margin-bottom: 8px;
            border-radius: 12px; border-left: 4px solid var(--primary-accent); line-height: 1.5;
        }

        .diary-entry { background: var(--subtle-bg-color); border-radius: 16px;
            padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--primary-accent); position: relative;
        }
        .diary-entry-header { display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .diary-date { font-size: 14px; color: var(--primary-accent); font-weight: 600; }
        .diary-mood { font-size: 24px; }
        .diary-content { color: var(--text-color); line-height: 1.6; margin-bottom: 12px; }
        .diary-form { background: var(--card-bg-color); border-radius: 20px;
            padding: 24px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }
        .diary-form.show { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-color); font-weight: 600; margin-bottom: 8px;
            font-size: 16px;
        }
        .form-input, .form-textarea { width: 100%; padding: 16px; border: 2px solid var(--card-border-color);
            border-radius: 16px; font-family: inherit; font-size: 16px; line-height: 1.5;
            outline: none; transition: all 0.3s ease; background: var(--subtle-bg-color);
            color: var(--text-color);
        }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:focus, .form-textarea:focus { border-color: var(--primary-accent); background: var(--bg-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .mood-selector { display: flex;
            justify-content: space-around; background: var(--subtle-bg-color); border-radius: 16px;
            padding: 16px; margin: 12px 0;
        }
        .mood-option { display: flex; flex-direction: column; align-items: center;
            cursor: pointer; padding: 8px; border-radius: 12px; transition: all 0.3s ease;
        }
        .mood-option.selected { background: var(--bg-color);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2); }
        .mood-option .mood-icon { font-size: 32px;
            margin-bottom: 4px; }
        .mood-option .mood-label { font-size: 12px; font-weight: 600; color: var(--secondary-text-color); }

        .neuro-item { background: var(--subtle-bg-color); padding: 16px; margin-bottom: 12px;
            border-radius: 12px; border-left: 4px solid var(--primary-accent); cursor: pointer;
            transition: all 0.3s ease;
        }
        .neuro-item:hover { transform: translateX(5px); }
        .neuro-item strong { color: var(--primary-accent); display: block; margin-bottom: 8px; }
        .neuro-explanation { display: none; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid var(--card-border-color); line-height: 1.6;
        }
        .neuro-explanation.show { display: block; animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }

        .preference-item { display: flex;
            justify-content: space-between; align-items: center; padding: 16px 0;
            border-bottom: 1px solid var(--card-border-color);
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0;
            bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px;
            width: 20px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .profile-picture-container { display: flex;
            justify-content: center; align-items: center; margin-bottom: 24px;
        }
        .profile-emoji {
            width: 100px;
            height: 100px; background: var(--subtle-bg-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 50px;
            border: 4px solid var(--primary-accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--text-color);
        }

        .emoji-selector-grid { display: flex;
            flex-wrap: wrap; gap: 12px; justify-content: center;
            background: var(--subtle-bg-color); padding: 16px; border-radius: 16px;
        }
        .emoji-choice { font-size: 28px; padding: 8px; border-radius: 50%;
            width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.2s ease-in-out; border: 2px solid transparent;
        }
        .emoji-choice:hover { background: rgba(102, 126, 234, 0.1); }
        .emoji-choice.selected { border-color: var(--primary-accent); transform: scale(1.15);
            background: var(--bg-color);
        }

        .toast {
            position: fixed;
            top: 60px; left: 50%; transform: translateX(-50%) translateY(-100px);
            width: calc(100% - 40px); max-width: 360px; background: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            color: var(--text-color); border-radius: 12px; padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); opacity: 0; transition: all 0.3s ease;
            z-index: 1500;
            border-left-width: 4px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-left-color: #4facfe; }
        .toast.warning { border-left-color: #f5576c; }
        
        /* === NUEVOS ESTILOS PARA PANTALLA DE BIENVENIDA Y EJERCICIOS === */
        .welcome-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .welcome-overlay.show { display: flex; }
        .welcome-content {
            background: var(--card-bg-color);
            color: var(--text-color);
            padding: 32px; border-radius: 20px;
            max-width: 380px; text-align: center;
        }

        .breathing-guide-container { text-align: center; display: none; }
        .breathing-guide-container.show { display: block; }
        #breathingInstruction { font-size: 20px; font-weight: 600; margin: 20px 0;
            color: var(--primary-accent);
        }
        .progress-bar-container { width: 100%; height: 10px; background: var(--subtle-bg-color);
            border-radius: 5px; overflow: hidden;
        }
        #breathingProgressBar { width: 0%;
            height: 100%; background: var(--primary-accent); transition: width 0.1s linear;
        }

        .chart-container {
            width: 100%;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

    </style>
</head>
<body>
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-content">
            <h2 class="section-title">¬°Bienvenido/a!</h2>
            <p class="section-subtitle" style="margin-bottom: 24px;">Personaliza tu espacio para comenzar.</p>
            <form id="welcomeForm" onsubmit="saveWelcomeProfile(event)">
                <div class="form-group">
                    <label for="welcomeUsernameInput" class="form-label">Tu Nombre</label>
                    <input type="text" id="welcomeUsernameInput" class="form-input" placeholder="¬øC√≥mo te llamas?" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Elige tu Emoji</label>
                    <div id="welcomeEmojiSelector" class="emoji-selector-grid"></div>
                    <input type="hidden" id="welcomeSelectedEmojiInput" value="">
                </div>
                <button type="submit" class="btn-mobile btn-primary" style="width:100%;">Comenzar Viaje</button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <div class="status-bar">EmotionSpace üíô</div>

        <div class="content-section active" id="home">
            <div class="section-header">
                <div class="section-title">Bienvenido, <span id="welcomeUsername"></span></div>
                <div class="section-subtitle">Tu espacio emocional personal</div>
            </div>

            <div class="card intro-card">
                <h3>üåü Un momento para ti</h3>
                <p>Este es tu rinc√≥n seguro donde cada emoci√≥n tiene un lugar. T√≥mate un momento para respirar y conectar contigo.</p>
                <div class="breathing-circle" id="breathingCircle">Respira</div>
            </div>

            <div class="video-container">
                <h3>üìπ Video de Bienvenida</h3>
                <p>Conoce m√°s sobre el manejo emocional</p>
                <div class="video-embed"><iframe src="https://www.youtube-nocookie.com/embed/tqOers0tWvI" title="Video de Bienvenida" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
            </div>

            <div class="card mood-section">
                <h3>¬øC√≥mo te sientes ahora?</h3>
                <div class="mood-input" id="homeMoodInput"></div>
            </div>

            <div class="card mood-section">
                <h3>Estad√≠sticas R√°pidas</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="totalInteractions">0</div><div class="stat-label">Interacciones</div></div>
                    <div class="stat-card"><div class="stat-number" id="positiveEmotions">0%</div><div class="stat-label">Emociones Positivas</div></div>
                    <div class="stat-card"><div class="stat-number" id="currentMood">---</div><div class="stat-label">Estado Actual</div></div>
                    <div class="stat-card"><div class="stat-number" id="moodStreak">0</div><div class="stat-label">D√≠as Seguidos</div></div>
                </div>
                <button class="btn-mobile btn-primary" style="width:100%; margin-top: 20px;" onclick="navigateToHistory()">üìä Ver historial completo</button>
            </div>
        </div>

        <div class="content-section" id="emotions">
            <div class="section-header">
                <div class="section-title">Emociones</div>
                <div class="section-subtitle">Explora y gestiona tus sentimientos</div>
            </div>
            <div class="control-buttons">
                <button class="btn-mobile btn-primary" onclick="randomizeEmotions()">üé≤ Emociones Aleatorias</button>
                <button class="btn-mobile btn-secondary" onclick="resetAllEmotions()">üîÑ Reiniciar Todo</button>
            </div>
            <div class="emotions-grid" id="emotionsGrid"></div>
        </div>

        <div class="content-section" id="history">
            <div class="section-header">
                <div class="section-title">Mi Historial</div>
                <div class="section-subtitle">Visualiza la evoluci√≥n de tus emociones</div>
            </div>
            <div class="card">
                <h3>Distribuci√≥n de Estados de √Ånimo</h3>
                <p>Basado en tus entradas del diario.</p>
                <div class="chart-container">
                    <canvas id="moodDistributionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Actividad del Diario</h3>
                <p>Entradas registradas en la √∫ltima semana.</p>
                <div class="chart-container">
                    <canvas id="diaryActivityChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="content-section" id="game">
            <div class="section-header">
                <div class="section-title">Rel√°jate y Juega</div>
                <div class="section-subtitle">Juegos para calmar la mente y liberar la tensi√≥n</div>
            </div>

            <div id="gameContent">
                <div class="card">
                    <h3>üßò‚Äç‚ôÄÔ∏è Respiraci√≥n Guiada</h3>
                    <p>Elige una t√©cnica para centrarte y encontrar la calma.</p>
                    <div class="control-buttons">
                        <button class="btn-mobile btn-primary" onclick="startBreathingExercise('4-7-8')">Respiraci√≥n 4-7-8</button>
                        <button class="btn-mobile btn-success" onclick="startBreathingExercise('cuadrada')">Respiraci√≥n Cuadrada</button>
                    </div>
                </div>
                
                <div class="card game-container">
                    <h3>ü´ß Burst de Tranquilidad</h3>
                    <p>Revienta las burbujas de estr√©s toc√°ndolas para liberar tensi√≥n.</p>
                    <div class="game-score">
                        <div>üéØ Burbujas: <span id="bubblesPopped">0</span></div>
                        <div>‚è±Ô∏è Tiempo: <span id="gameTime">60</span>s</div>
                    </div>
                    <div class="game-area" id="gameArea"></div>
                    <div class="control-buttons">
                        <button id="startGameBtn" class="btn-mobile btn-primary" onclick="startGame()">üéÆ Iniciar</button>
                        <button class="btn-mobile btn-secondary" onclick="resetGame()">üîÑ Reiniciar</button>
                    </div>
                </div>
                <div class="card memory-game-container">
                    <h3>üß† Memoria Emocional</h3>
                    <p>Encuentra las parejas de emociones para entrenar tu concentraci√≥n.</p>
                    <div class="game-score">
                        <div>üéØ Intentos: <span id="memoryTries">0</span></div>
                        <div>üíñ Parejas: <span id="memoryMatches">0</span>/<span id="totalPairs">6</span></div>
                    </div>
                    <div class="memory-game-grid" id="memoryGameArea"></div>
                    <div class="control-buttons">
                        <button class="btn-mobile btn-primary" onclick="setupMemoryGame()">üéÆ Iniciar</button>
                        <button class="btn-mobile btn-secondary" onclick="resetMemoryGame()">üîÑ Reiniciar</button>
                    </div>
                </div>
            </div>
            
            <div class="breathing-guide-container" id="breathingExerciseContainer">
                <div class="welcome-content">
                    <h2 class="section-title">Ejercicio de Respiraci√≥n</h2>
                    <div class="breathing-circle" id="breathingExerciseCircle"></div>
                    <div id="breathingInstruction"></div>
                    <div class="progress-bar-container">
                        <div id="breathingProgressBar"></div>
                    </div>
                    <button class="btn-mobile btn-secondary" style="width:100%; margin-top: 20px;" onclick="stopBreathingExercise()">Parar</button>
                </div>
            </div>
        </div>

        <div class="content-section" id="diary">
            <div class="section-header">
                <div class="section-title">Mi Diario</div>
                <div class="section-subtitle">Expresa y procesa tus emociones</div>
            </div>
            <div class="card diary-stats">
                <div class="diary-stat-card"><div class="diary-stat-number" id="totalEntries">0</div><div class="diary-stat-label">Entradas</div></div>
                <div class="diary-stat-card"><div class="diary-stat-number" id="writingStreak">0</div><div class="diary-stat-label">D√≠as Escribiendo</div></div>
            </div>
            <div class="card writing-prompt">
                <div style="font-size: 48px; margin-bottom: 12px;">üí°</div>
                <div id="promptText" style="margin-bottom: 16px;">¬øQu√© pensamiento positivo puedes llevar contigo hoy?</div>
                <button class="btn-mobile btn-primary" onclick="getNewPrompt()">Nueva Idea</button>
            </div>

            <button class="btn-mobile btn-primary" style="width: 100%; margin: 20px 0;" onclick="toggleDiaryForm()">‚úçÔ∏è Escribir Nueva Entrada</button>

            <div class="diary-form" id="diaryForm">
                <form id="diaryEntryForm">
                    <div class="form-group">
                        <label class="form-label">¬øQu√© emoci√≥n sientes?</label>
                        <div class="mood-selector" id="diaryMoodSelector">
                            </div>
                        <input type="hidden" id="selectedDiaryMood" required>
                    </div>
                    <div class="form-group">
                        <label for="diaryEntryText" class="form-label">Escribe tu entrada:</label>
                        <textarea id="diaryEntryText" class="form-textarea" placeholder="¬øQu√© pas√≥ hoy? ¬øC√≥mo te sientes al respecto?" required></textarea>
                    </div>
                    <div class="control-buttons">
                        <button type="submit" class="btn-mobile btn-primary" style="width:100%;">Guardar Entrada</button>
                        <button type="button" class="btn-mobile btn-secondary" style="width:100%;" onclick="toggleDiaryForm()">Cerrar</button>
                    </div>
                </form>
            </div>
            
            <div id="diaryEntries"></div>
        </div>

        <div class="content-section" id="learn">
            <div class="section-header">
                <div class="section-title">Aprende</div>
                <div class="section-subtitle">Comprende la ciencia de las emociones</div>
            </div>
            <div class="video-container">
                <h3>üìö Video Educativo</h3>
                <p>Profundiza en el conocimiento emocional</p>
                <div class="video-embed"><iframe src="https://www.youtube-nocookie.com/embed/o0cmNNGgvvg" title="Video Educativo" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
            </div>
            <div class="card neuro-section">
                <h3>üß† Neurotransmisores y Emociones</h3>
                <p>Toca cada uno para conocer m√°s:</p>
                <div class="neuro-list">
                    <div class="neuro-item" onclick="toggleNeuroExplanation(this)">
                        <strong>Serotonina</strong>
                        <div class="neuro-explanation"><strong>Funciones:</strong> Regula el ciclo del sue√±o, controla el apetito, mejora el estado de √°nimo y reduce la ansiedad.<br><br><strong>C√≥mo aumentarla:</strong> Exposici√≥n al sol, ejercicio regular, alimentos ricos en tript√≥fano (pavo, huevos), meditaci√≥n.</div>
                    </div>
                    <div class="neuro-item" onclick="toggleNeuroExplanation(this)">
                        <strong>Dopamina</strong>
                        <div class="neuro-explanation"><strong>Funciones:</strong> Motivaci√≥n, b√∫squeda de recompensas, aprendizaje y control motor.<br><br><strong>C√≥mo aumentarla:</strong> Completar tareas, escuchar m√∫sica, hacer ejercicio, celebrar peque√±os logros.</div>
                    </div>
                    <div class="neuro-item" onclick="toggleNeuroExplanation(this)">
                        <strong>Oxitocina</strong>
                        <div class="neuro-explanation"><strong>Funciones:</strong> Fortalece v√≠nculos afectivos, promueve la empat√≠a y confianza, y reduce el estr√©s.<br><br><strong>C√≥mo aumentarla:</strong> Contacto f√≠sico (abrazos), pasar tiempo con seres queridos, actos de bondad.</div>
                    </div>
                    <div class="neuro-item" onclick="toggleNeuroExplanation(this)">
                        <strong>Cortisol</strong>
                        <div class="neuro-explanation"><strong>Funciones:</strong> Es la "hormona del estr√©s". Prepara al cuerpo para la acci√≥n, pero en exceso es da√±ina.<br><br><strong>C√≥mo manejarlo:</strong> Sue√±o adecuado, t√©cnicas de relajaci√≥n, ejercicio y una dieta balanceada.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section" id="profile">
            <div class="section-header">
                <div class="section-title">Mi Perfil</div>
                <div class="section-subtitle">Configura tu experiencia</div>
            </div>
            <div class="card">
                <div class="profile-picture-container">
                    <div id="profileEmojiDisplay" class="profile-emoji">üë§</div>
                </div>
                <form id="profileForm" onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label for="profileUsernameInput" class="form-label">Tu Nombre</label>
                        <input type="text" id="profileUsernameInput" class="form-input" placeholder="Nombre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tu Emoji</label>
                        <div id="emojiSelector" class="emoji-selector-grid"></div>
                        <input type="hidden" id="selectedEmojiInput">
                    </div>
                    <div class="preference-item">
                        <label for="darkModeToggle">Modo Oscuro</label>
                        <label class="switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button type="submit" class="btn-mobile btn-primary" style="width:100%;">Guardar Cambios</button>
                </form>
            </div>
        </div>

        <div class="tab-navigation">
            <div class="tab-item active" onclick="showSection('home', this)">
                <div class="icon">üè†</div>
                <div class="label">Inicio</div>
            </div>
            <div class="tab-item" onclick="showSection('emotions', this)">
                <div class="icon">üíñ</div>
                <div class="label">Emociones</div>
            </div>
            <div class="tab-item" onclick="showSection('history', this)">
                <div class="icon">üìà</div>
                <div class="label">Historial</div>
            </div>
            <div class="tab-item" onclick="showSection('game', this)">
                <div class="icon">üéÆ</div>
                <div class="label">Juegos</div>
            </div>
            <div class="tab-item" onclick="showSection('diary', this)">
                <div class="icon">üìì</div>
                <div class="label">Diario</div>
            </div>
            <div class="tab-item" onclick="showSection('learn', this)">
                <div class="icon">üß†</div>
                <div class="label">Aprende</div>
            </div>
            <div class="tab-item" onclick="showSection('profile', this)">
                <div class="icon">üë§</div>
                <div class="label">Perfil</div>
            </div>
        </div>
    </div>

    <div class="modal" id="adviceModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <div class="modal-header">
                <div id="modalEmoji" class="modal-emoji"></div>
                <div>
                    <h3 id="modalTitle"></h3>
                    <p id="modalSubtitle" style="color: var(--secondary-text-color);"></p>
                </div>
            </div>
            <div class="advice-section" id="adviceListContainer">
                <h4>Recomendaciones</h4>
                <ul id="adviceList" class="advice-list"></ul>
            </div>
            <div id="additionalInfo"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        const emotionsData = {
            'Alegr√≠a': {
                emoji: 'üòÑ',
                subtitle: 'Una emoci√≥n de bienestar y felicidad.',
                advice: [
                    'Comparte tu alegr√≠a con otros. La felicidad se multiplica cuando se comparte.',
                    'Guarda un recuerdo de este momento. Escr√≠belo en tu diario para revivirlo m√°s tarde.',
                    'Disfruta plenamente el momento presente. T√≥mate un respiro y aprecia lo que te hace feliz.'
                ],
                activities: [
                    'Actividad: Escucha tu canci√≥n favorita y baila.',
                    'Actividad: Llama a un ser querido y cu√©ntale tu d√≠a.',
                    'Actividad: Sal a caminar y observa las peque√±as cosas bonitas a tu alrededor.'
                ]
            },
            'Tristeza': {
                emoji: 'üò¢',
                subtitle: 'Una emoci√≥n que nos permite procesar las p√©rdidas.',
                advice: [
                    'Perm√≠tete sentir la tristeza sin juzgarte. Es v√°lido no estar bien todo el tiempo.',
                    'No te a√≠sles. Habla con alguien de confianza sobre c√≥mo te sientes.',
                    'Utiliza este momento para reflexionar sobre lo que valoras. La tristeza a menudo nos muestra lo que m√°s nos importa.'
                ],
                activities: [
                    'Actividad: Ve una pel√≠cula que te haga sentir mejor.',
                    'Actividad: Abraza una almohada o a tu mascota. El contacto f√≠sico ayuda a liberar la oxitocina.',
                    'Actividad: Escribe en tu diario lo que te est√° causando dolor.'
                ]
            },
            'Enojo': {
                emoji: 'üò°',
                subtitle: 'Una emoci√≥n que se√±ala que un l√≠mite ha sido cruzado.',
                advice: [
                    'Antes de reaccionar, respira profundo. Cuenta hasta diez para calmarte.',
                    'Expresa tu enojo de forma constructiva. Usa frases como "Me siento frustrado cuando..."',
                    'Identifica la causa de tu enojo. A menudo, esconde otras emociones como frustraci√≥n o impotencia.'
                ],
                activities: [
                    'Actividad: Haz ejercicio o estiramientos para liberar la tensi√≥n f√≠sica.',
                    'Actividad: Golpea una almohada o grita en un espacio seguro para desahogarte.',
                    'Actividad: Escribe una carta a la persona o situaci√≥n que te enoj√≥, pero no la env√≠es.'
                ]
            },
            'Miedo': {
                emoji: 'üò®',
                subtitle: 'Una emoci√≥n que nos protege de un peligro percibido.',
                advice: [
                    'Analiza qu√© te causa miedo. A veces, nombrarlo le quita poder.',
                    'Recuerda tus fortalezas. Has superado desaf√≠os antes, puedes con este tambi√©n.',
                    'Enf√≥cate en lo que puedes controlar. Acepta lo que no puedes y prep√°rate para lo que s√≠.'
                ],
                activities: [
                    'Actividad: Practica un ejercicio de respiraci√≥n para calmar el sistema nervioso.',
                    'Actividad: Visualiza un lugar seguro y tranquilo en tu mente.',
                    'Actividad: Aprende algo nuevo o investiga m√°s sobre lo que te asusta.'
                ]
            },
            'Sorpresa': {
                emoji: 'üòÆ',
                subtitle: 'Una emoci√≥n de reacci√≥n a lo inesperado.',
                advice: [
                    'T√≥mate un momento para asimilar la situaci√≥n.',
                    'Preg√∫ntate si la sorpresa es positiva o negativa. A menudo, el miedo y la alegr√≠a se confunden en la sorpresa.',
                    'Acepta el cambio. La sorpresa es una oportunidad para adaptarte a lo nuevo.'
                ],
                activities: [
                    'Actividad: Registra el momento en tu diario para no olvidarlo.',
                    'Actividad: Si√©ntate y respira para estabilizarte.',
                    'Actividad: Comparte la sorpresa con alguien y ve c√≥mo reaccionan.'
                ]
            },
            'Calma': {
                emoji: 'üòå',
                subtitle: 'Un estado de paz mental y emocional.',
                advice: [
                    'Aprecia este momento de calma. Es un regalo en un mundo ocupado.',
                    'Busca la fuente de esta calma. ¬øQu√© actividades, personas o lugares te la proporcionan?',
                    'Escribe sobre tu estado. Analizar c√≥mo llegaste aqu√≠ te ayudar√° a encontrar el camino de vuelta cuando lo necesites.'
                ],
                activities: [
                    'Actividad: Medita por unos minutos o haz un ejercicio de mindfulness.',
                    'Actividad: Escucha m√∫sica relajante o sonidos de la naturaleza.',
                    'Actividad: Sal a un entorno natural y disfruta del aire fresco.'
                ]
            }
        };

        const homeMoodInput = document.getElementById('homeMoodInput');
        const emotionsGrid = document.getElementById('emotionsGrid');
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const welcomeUsernameSpan = document.getElementById('welcomeUsername');
        const profileUsernameInput = document.getElementById('profileUsernameInput');
        const profileEmojiDisplay = document.getElementById('profileEmojiDisplay');
        const totalInteractions = document.getElementById('totalInteractions');
        const positiveEmotions = document.getElementById('positiveEmotions');
        const currentMood = document.getElementById('currentMood');
        const moodStreak = document.getElementById('moodStreak');
        const diaryEntriesContainer = document.getElementById('diaryEntries');
        const totalEntriesStat = document.getElementById('totalEntries');
        const writingStreakStat = document.getElementById('writingStreak');
        const diaryForm = document.getElementById('diaryForm');
        const diaryEntryText = document.getElementById('diaryEntryText');
        const selectedDiaryMoodInput = document.getElementById('selectedDiaryMood');
        const diaryMoodSelector = document.getElementById('diaryMoodSelector');
        const diaryEntryForm = document.getElementById('diaryEntryForm');
        const promptText = document.getElementById('promptText');
        
        let moodDistributionChart;
        let diaryActivityChart;

        const prompts = [
            "¬øQu√© te hizo sonre√≠r hoy?",
            "¬øQu√© peque√±o logro conseguiste hoy?",
            "¬øQu√© pensamiento positivo puedes llevar contigo hoy?",
            "Describe un momento de calma o paz que experimentaste.",
            "¬øQu√© cosa nueva aprendiste hoy?",
            "¬øQu√© est√°s agradecido de tener en tu vida?"
        ];

        function showSection(sectionId, element) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            const tabItems = document.querySelectorAll('.tab-item');
            tabItems.forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }

            if (sectionId === 'history') {
                renderCharts();
            }
        }

        function toggleDiaryForm() {
            diaryForm.classList.toggle('show');
            if (diaryForm.classList.contains('show')) {
                diaryForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function recordEmotionInteraction(emotion, type) {
            const interactions = JSON.parse(localStorage.getItem('emotionInteractions')) || [];
            interactions.push({
                date: new Date().toISOString(),
                emotion: emotion,
                type: type
            });
            localStorage.setItem('emotionInteractions', JSON.stringify(interactions));
            updateStats();
            if (document.getElementById('history').classList.contains('active')) {
                renderCharts();
            }
        }

        function saveDiaryEntry(event) {
            event.preventDefault();
            const entryText = diaryEntryText.value;
            const entryMood = selectedDiaryMoodInput.value;

            if (!entryText || !entryMood) {
                showToast("Por favor, selecciona una emoci√≥n y escribe tu entrada.", 'warning');
                return;
            }

            const entries = JSON.parse(localStorage.getItem('diaryEntries')) || [];
            const newEntry = {
                date: new Date().toISOString(),
                mood: entryMood,
                text: entryText
            };
            entries.push(newEntry);
            localStorage.setItem('diaryEntries', JSON.stringify(entries));

            recordEmotionInteraction(entryMood, 'diary_entry');
            showToast("Entrada guardada con √©xito", 'success');

            diaryEntryText.value = '';
            selectedDiaryMoodInput.value = '';
            document.querySelectorAll('.mood-option').forEach(option => option.classList.remove('selected'));
            
            toggleDiaryForm();
            renderDiaryEntries();
        }

        function renderDiaryEntries() {
            const entries = JSON.parse(localStorage.getItem('diaryEntries')) || [];
            diaryEntriesContainer.innerHTML = '';
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (entries.length === 0) {
                diaryEntriesContainer.innerHTML = '<div class="card" style="text-align: center;">A√∫n no tienes entradas en tu diario. ¬°An√≠mate a escribir la primera!</div>';
            } else {
                entries.forEach(entry => {
                    const date = new Date(entry.date).toLocaleDateString('es-ES', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });
                    const emojiInfo = emotionsData[entry.mood];
                    const entryHtml = `
                        <div class="diary-entry card">
                            <div class="diary-entry-header">
                                <span class="diary-date">${date}</span>
                                <span class="diary-mood">${emojiInfo ? emojiInfo.emoji : ''}</span>
                            </div>
                            <div class="diary-content">${entry.text}</div>
                        </div>
                    `;
                    diaryEntriesContainer.innerHTML += entryHtml;
                });
            }
        }

        function getWritingStreak(entries) {
            if (entries.length === 0) return 0;
            
            const sortedDates = entries.map(e => new Date(e.date).toLocaleDateString()).filter((value, index, self) => self.indexOf(value) === index).sort();
            
            let streak = 0;
            let currentDay = new Date();
            let lastDay = new Date(sortedDates[sortedDates.length - 1]);
            
            if (lastDay.toLocaleDateString() !== currentDay.toLocaleDateString() && new Date(lastDay.setDate(lastDay.getDate() + 1)).toLocaleDateString() !== currentDay.toLocaleString()) {
                return 0;
            }

            for (let i = sortedDates.length - 1; i >= 0; i--) {
                const date = new Date(sortedDates[i]);
                if (date.toLocaleDateString() === currentDay.toLocaleDateString() || new Date(date.setDate(date.getDate() + 1)).toLocaleDateString() === currentDay.toLocaleDateString()) {
                    streak++;
                    currentDay = new Date(currentDay.setDate(currentDay.getDate() - 1));
                } else {
                    break;
                }
            }
            return streak;
        }

        function renderHomeEmotions() {
            homeMoodInput.innerHTML = Object.keys(emotionsData).map(key => {
                const emotion = emotionsData[key];
                return `<div class="mood-emoji" onclick="handleEmotionClick('${key}')">
                            <div class="icon">${emotion.emoji}</div>
                            <div class="emoji-label">${key}</div>
                        </div>`;
            }).join('');

            renderDiaryMoodSelector();
        }

        function handleEmotionClick(emotionName) {
            recordEmotionInteraction(emotionName, 'mood_input');
            showAdviceModal(emotionName);
        }

        function renderEmotions() {
            emotionsGrid.innerHTML = Object.keys(emotionsData).map(key => {
                const emotion = emotionsData[key];
                const level = Math.random() * 100;
                return `<div class="emotion-card" onclick="showAdviceModal('${key}')">
                            <div class="emotion-icon">${emotion.emoji}</div>
                            <div class="emotion-name">${key}</div>
                            <div class="level-bar"><div class="level-fill" style="width:${level}%"></div></div>
                            <div class="level-percentage">${Math.round(level)}%</div>
                        </div>`;
            }).join('');
        }

        function renderDiaryMoodSelector() {
            diaryMoodSelector.innerHTML = Object.keys(emotionsData).map(key => {
                const emotion = emotionsData[key];
                return `<div class="mood-option" onclick="selectDiaryMood(this, '${key}')">
                            <div class="mood-icon">${emotion.emoji}</div>
                            <div class="mood-label">${key}</div>
                        </div>`;
            }).join('');
        }

        function selectDiaryMood(element, mood) {
            document.querySelectorAll('.mood-option').forEach(option => option.classList.remove('selected'));
            element.classList.add('selected');
            selectedDiaryMoodInput.value = mood;
        }

        function showAdviceModal(emotionName) {
            const modal = document.getElementById('adviceModal');
            const data = emotionsData[emotionName];
            
            document.getElementById('modalEmoji').textContent = data.emoji;
            document.getElementById('modalTitle').textContent = emotionName;
            document.getElementById('modalSubtitle').textContent = data.subtitle;

            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';
            data.advice.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                adviceList.appendChild(li);
            });
            
            const activitiesContainer = document.getElementById('additionalInfo');
            activitiesContainer.innerHTML = `
                <div class="advice-section">
                    <h4>Actividades Sugeridas</h4>
                    <ul class="advice-list">
                        ${data.activities.map(act => `<li>${act}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('adviceModal');
            modal.classList.remove('show');
        }

        function randomizeEmotions() {
            renderEmotions();
        }

        function resetAllEmotions() {
            renderEmotions();
        }
        
        function updateStats() {
            const interactions = JSON.parse(localStorage.getItem('emotionInteractions')) || [];
            const diaryEntries = JSON.parse(localStorage.getItem('diaryEntries')) || [];
            totalInteractions.textContent = interactions.length;
            totalEntriesStat.textContent = diaryEntries.length;

            const positiveMoods = ['Alegr√≠a', 'Calma'];
            const positiveCount = interactions.filter(e => positiveMoods.includes(e.emotion)).length;
            const positivePercentage = interactions.length > 0 ? (positiveCount / interactions.length * 100).toFixed(0) : 0;
            positiveEmotions.textContent = `${positivePercentage}%`;

            const lastEntry = interactions[interactions.length - 1];
            if (lastEntry) {
                currentMood.textContent = lastEntry.emotion;
            } else {
                currentMood.textContent = '---';
            }

            const uniqueDates = new Set(interactions.map(i => new Date(i.date).toLocaleDateString()));
            moodStreak.textContent = getStreak(Array.from(uniqueDates));
            writingStreakStat.textContent = getStreak(diaryEntries.map(e => new Date(e.date).toLocaleDateString()));
        }

        function getStreak(dates) {
            if (dates.length === 0) return 0;

            let streak = 0;
            let lastDate = new Date();

            const today = lastDate.toLocaleDateString();
            const yesterday = new Date(lastDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toLocaleDateString();
            
            const uniqueSortedDates = [...new Set(dates)].sort((a,b) => new Date(a) - new Date(b));
            
            if (uniqueSortedDates.includes(today)) {
                lastDate = today;
                streak = 1;
            } else if (uniqueSortedDates.includes(yesterdayString)) {
                lastDate = yesterdayString;
                streak = 1;
            } else {
                return 0;
            }

            for (let i = uniqueSortedDates.length - 1; i >= 0; i--) {
                const currentDate = uniqueSortedDates[i];
                const prevDay = new Date(currentDate);
                prevDay.setDate(prevDay.getDate() + 1);
                
                if (prevDay.toLocaleDateString() === lastDate) {
                    streak++;
                    lastDate = currentDate;
                }
            }
            return streak;
        }

        function renderCharts() {
            const interactions = JSON.parse(localStorage.getItem('emotionInteractions')) || [];
            updateMoodDistributionChart(interactions);
            updateDiaryActivityChart(interactions);
        }

        function updateMoodDistributionChart(interactions) {
            if (moodDistributionChart) {
                moodDistributionChart.destroy();
            }

            const emotionCounts = {};
            Object.keys(emotionsData).forEach(emotion => emotionCounts[emotion] = 0);
            interactions.forEach(i => {
                if (i.emotion in emotionCounts) {
                    emotionCounts[i.emotion]++;
                }
            });

            const labels = Object.keys(emotionCounts);
            const data = Object.values(emotionCounts);
            const backgroundColors = labels.map(label => {
                if (['Alegr√≠a', 'Calma'].includes(label)) return '#4facfe';
                if (['Tristeza', 'Enojo', 'Miedo'].includes(label)) return '#f5576c';
                return '#999';
            });

            const ctx = document.getElementById('moodDistributionChart').getContext('2d');
            moodDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                            }
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });
        }

        function updateDiaryActivityChart(interactions) {
            if (diaryActivityChart) {
                diaryActivityChart.destroy();
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                dates.push(d);
            }

            const activityData = dates.map(date => {
                const count = interactions.filter(i => {
                    const entryDate = new Date(i.date);
                    return entryDate.getDate() === date.getDate() &&
                           entryDate.getMonth() === date.getMonth() &&
                           entryDate.getFullYear() === date.getFullYear();
                }).length;
                return count;
            });
            
            const labels = dates.map(date => date.toLocaleDateString('es-ES', { weekday: 'short' }));
            
            const ctx = document.getElementById('diaryActivityChart').getContext('2d');
            diaryActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Registros por d√≠a',
                        data: activityData,
                        backgroundColor: '#667eea',
                        borderColor: '#764ba2',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--card-border-color'),
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                            },
                            grid: {
                                display: false,
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }


        function setupEmojiSelector(containerId, inputId) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            const emojis = ['üòä', 'üòÇ', 'üòé', 'ü§©', 'ü§î', 'üò¥', 'üòú', 'üòá', '‚ù§Ô∏è'];
            container.innerHTML = emojis.map(emoji => 
                `<span class="emoji-choice" data-emoji="${emoji}" onclick="selectEmoji(this, '${inputId}')">${emoji}</span>`
            ).join('');

            if (input.value) {
                const selected = container.querySelector(`[data-emoji="${input.value}"]`);
                if (selected) {
                    selected.classList.add('selected');
                }
            }
        }

        function selectEmoji(element, inputId) {
            const container = element.parentElement;
            container.querySelectorAll('.emoji-choice').forEach(e => e.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById(inputId).value = element.getAttribute('data-emoji');
        }
        
        function saveWelcomeProfile(event) {
            event.preventDefault();
            const username = document.getElementById('welcomeUsernameInput').value;
            const emoji = document.getElementById('welcomeSelectedEmojiInput').value;
            if (username && emoji) {
                localStorage.setItem('username', username);
                localStorage.setItem('userEmoji', emoji);
                welcomeOverlay.classList.remove('show');
                updateProfileDisplay();
                showToast("¬°Bienvenido/a, " + username + "!", 'success');
            } else {
                showToast("Por favor, completa todos los campos.", 'warning');
            }
        }

        function saveProfile(event) {
            event.preventDefault();
            const username = document.getElementById('profileUsernameInput').value;
            const emoji = document.getElementById('selectedEmojiInput').value;
            localStorage.setItem('username', username);
            localStorage.setItem('userEmoji', emoji);
            updateProfileDisplay();
            showToast("Perfil actualizado.", 'success');
        }

        function updateProfileDisplay() {
            const username = localStorage.getItem('username');
            const userEmoji = localStorage.getItem('userEmoji');
            if (username) {
                welcomeUsernameSpan.textContent = username;
                profileUsernameInput.value = username;
            }
            if (userEmoji) {
                profileEmojiDisplay.textContent = userEmoji;
                document.getElementById('selectedEmojiInput').value = userEmoji;
            }
        }
        
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function navigateToHistory() {
            showSection('history', document.querySelector('.tab-item[onclick="showSection(\'history\', this)"]'));
        }

        function getNewPrompt() {
            const randomIndex = Math.floor(Math.random() * prompts.length);
            promptText.textContent = prompts[randomIndex];
        }


        let bubblesPopped = 0;
        let gameTime = 60;
        let gameInterval;

        function startGame() {
            const gameArea = document.getElementById('gameArea');
            bubblesPopped = 0;
            gameTime = 60;
            document.getElementById('bubblesPopped').textContent = bubblesPopped;
            document.getElementById('gameTime').textContent = gameTime;
            gameArea.innerHTML = '';
            document.getElementById('startGameBtn').disabled = true;

            gameInterval = setInterval(() => {
                gameTime--;
                document.getElementById('gameTime').textContent = gameTime;
                if (gameTime <= 0) {
                    clearInterval(gameInterval);
                    alert(`¬°Tiempo! Reventaste ${bubblesPopped} burbujas.`);
                    document.getElementById('startGameBtn').disabled = false;
                }
            }, 1000);

            for (let i = 0; i < 15; i++) {
                createBubble();
            }
        }

        function createBubble() {
            const gameArea = document.getElementById('gameArea');
            const bubble = document.createElement('div');
            const size = Math.random() * 40 + 20;
            bubble.className = 'bubble';
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.left = `${Math.random() * (gameArea.clientWidth - size)}px`;
            bubble.style.animationDuration = `${Math.random() * 3 + 2}s`;
            bubble.style.animationDelay = `${Math.random() * 1}s`;
            bubble.onclick = () => {
                bubblesPopped++;
                document.getElementById('bubblesPopped').textContent = bubblesPopped;
                bubble.remove();
                createBubble();
            };
            gameArea.appendChild(bubble);
        }

        function resetGame() {
            clearInterval(gameInterval);
            document.getElementById('bubblesPopped').textContent = '0';
            document.getElementById('gameTime').textContent = '60';
            document.getElementById('gameArea').innerHTML = '';
            document.getElementById('startGameBtn').disabled = false;
        }

        let isBreathing = false;
        let breathingInterval;
        let breathingTimeout;
        const breathingContainer = document.getElementById('breathingExerciseContainer');
        const gameContent = document.getElementById('gameContent');
        const breathingCircle = document.getElementById('breathingExerciseCircle');
        const breathingInstruction = document.getElementById('breathingInstruction');
        const breathingProgressBar = document.getElementById('breathingProgressBar');
        let progressInterval;

        function startBreathingExercise(type) {
            gameContent.style.display = 'none';
            breathingContainer.style.display = 'flex';
            breathingContainer.scrollIntoView({ behavior: 'smooth' });

            const totalDuration = 180;
            let progress = 0;
            let totalSteps = totalDuration * 10;
            let currentStep = 0;

            if (type === '4-7-8') {
                runBreathingCycle(4, 7, 8, '4-7-8');
            } else if (type === 'cuadrada') {
                runBreathingCycle(4, 4, 4, 'cuadrada');
            }

            progressInterval = setInterval(() => {
                currentStep++;
                progress = (currentStep / totalSteps) * 100;
                breathingProgressBar.style.width = `${progress}%`;
            }, 100);

            breathingTimeout = setTimeout(() => {
                stopBreathingExercise();
                alert("¬°Ejercicio de respiraci√≥n completado!");
            }, totalDuration * 1000);
        }

        function runBreathingCycle(inhale, hold, exhale, type) {
            isBreathing = true;
            let step = 0;
            const instructions = type === '4-7-8' ? ['Inhala...', 'Aguanta...', 'Exhala...'] : ['Inhala...', 'Aguanta...', 'Exhala...', 'Aguanta...'];
            const durations = type === '4-7-8' ? [inhale, hold, exhale] : [inhale, hold, exhale, hold];
            const animationDurations = type === '4-7-8' ? [4, 7, 8] : [4, 4, 4, 4];
            let totalTime = durations.reduce((a, b) => a + b, 0);

            breathingInterval = setInterval(() => {
                const currentInstruction = instructions[step];
                const currentDuration = durations[step];
                const currentAnimationDuration = animationDurations[step];
                
                breathingInstruction.textContent = `${currentInstruction} (${currentDuration}s)`;
                breathingCircle.style.animationDuration = `${currentAnimationDuration}s`;
                breathingCircle.style.animationName = currentInstruction.includes('Inhala') ? 'breathe' : 'none';

                if (currentInstruction.includes('Exhala')) {
                    breathingCircle.style.animationName = 'breathe-reverse';
                }

                step = (step + 1) % instructions.length;

                if (step === 0) {
                    breathingCircle.style.animation = 'none';
                    void breathingCircle.offsetWidth;
                    breathingCircle.style.animation = null;
                }

            }, totalTime * 1000);

            breathingCircle.style.animationPlayState = 'running';
        }

        function stopBreathingExercise() {
            isBreathing = false;
            clearInterval(breathingInterval);
            clearInterval(progressInterval);
            clearTimeout(breathingTimeout);
            breathingContainer.style.display = 'none';
            gameContent.style.display = 'block';
            breathingCircle.style.animationName = 'none';
            breathingProgressBar.style.width = '0%';
        }

        let memoryGameCards = [];
        let flippedCards = [];
        let lockBoard = false;
        let matchCount = 0;
        let tryCount = 0;

        const memoryEmotions = [
            'üòÅ', 'üò¢', 'üò°', 'üòå', 'üòÆ', 'ü§©'
        ];

        function setupMemoryGame() {
            const memoryGameArea = document.getElementById('memoryGameArea');
            memoryGameCards = [...memoryEmotions, ...memoryEmotions]
                .sort(() => 0.5 - Math.random())
                .map(emoji => ({ emoji, matched: false }));
            
            memoryGameArea.innerHTML = '';
            matchCount = 0;
            tryCount = 0;
            document.getElementById('memoryTries').textContent = tryCount;
            document.getElementById('memoryMatches').textContent = matchCount;

            memoryGameCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('memory-card');
                cardElement.dataset.index = index;
                cardElement.innerHTML = `
                    <div class="back-face">üß†</div>
                    <div class="front-face">${card.emoji}</div>
                `;
                cardElement.addEventListener('click', () => flipCard(cardElement));
                memoryGameArea.appendChild(cardElement);
            });
        }

        function flipCard(cardElement) {
            if (lockBoard || cardElement.classList.contains('flip') || cardElement.classList.contains('match')) {
                return;
            }

            cardElement.classList.add('flip');
            flippedCards.push(cardElement);

            if (flippedCards.length === 2) {
                tryCount++;
                document.getElementById('memoryTries').textContent = tryCount;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [firstCard, secondCard] = flippedCards;
            const isMatch = firstCard.querySelector('.front-face').textContent === secondCard.querySelector('.front-face').textContent;

            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            lockBoard = true;
            const [firstCard, secondCard] = flippedCards;
            firstCard.classList.add('match');
            secondCard.classList.add('match');
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            matchCount++;
            document.getElementById('memoryMatches').textContent = matchCount;
            resetBoard();
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                flippedCards.forEach(card => card.classList.remove('flip'));
                resetBoard();
            }, 1500);
        }

        function resetBoard() {
            [flippedCards, lockBoard] = [[], false];
        }

        function resetMemoryGame() {
            setupMemoryGame();
        }

        function toggleNeuroExplanation(element) {
            const explanation = element.querySelector('.neuro-explanation');
            const allExplanations = document.querySelectorAll('.neuro-explanation');
            allExplanations.forEach(exp => {
                if (exp !== explanation) {
                    exp.classList.remove('show');
                }
            });
            explanation.classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hasProfile = localStorage.getItem('username');
            if (!hasProfile) {
                welcomeOverlay.classList.add('show');
                setupEmojiSelector('welcomeEmojiSelector', 'welcomeSelectedEmojiInput');
            } else {
                updateProfileDisplay();
            }

            const darkModeToggle = document.getElementById('darkModeToggle');
            if (localStorage.getItem('darkMode') === 'true') {
                darkModeToggle.checked = true;
                document.body.classList.add('dark-mode');
            }
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
            });
            
            renderHomeEmotions();
            renderEmotions();
            renderDiaryEntries();
            updateStats();
            setupEmojiSelector('emojiSelector', 'selectedEmojiInput');
            getNewPrompt();
            setupMemoryGame();
            
            diaryEntryForm.addEventListener('submit', saveDiaryEntry);
            renderCharts();
        });
    </script>
</body>
</html>
